# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Configuration

These values are project-specific and defined in `.lando.yml` and `vite.config.mjs`:

| Setting | Value | Files to update |
|---------|-------|-----------------|
| Project slug | `craftstarter` | `.lando.yml`, `vite.config.mjs`, this file |
| Vite dev port | `9028` | `vite.config.mjs` |
| Local URL | `https://craftstarter.lndo.site/` | Derived from slug |
| PHPMyAdmin URL | `https://pma.craftstarter.lndo.site/` | Derived from slug |

## System Requirements

- PHP 8.5+
- MySQL 8.0
- Node 22
- [Yarn v4](https://yarnpkg.com/en/docs/install)

## Development Commands

### Frontend (JavaScript/CSS)

- **Production build**: `yarn build`
- **Dev build**: `yarn dev`
- **Dev server with HMR**: Vite dev server runs on `https://localhost:{port}` (see Project Configuration)
  - Configured in `vite.config.mjs` with HTTPS and CORS for Lando
  - Toggle via `ENVIRONMENT` or `CRAFT_ENVIRONMENT` env vars (see `config/vite.php`)
- **Linting**:
  - JS: `yarn lint:js` or `yarn lint:js:fix`
  - CSS: `yarn lint:css` or `yarn lint:css:fix`
- **Security audits**:
  - Moderate: `yarn audit:moderate`
  - High: `yarn audit:high`

### Craft CMS

- **Run console**: `./craft` (executable)
- **Clear caches**: `./craft clear-caches/all`
- **Apply migrations**: `./craft up`
- **Project config**: Stored in `config/project/` directory with YAML files

### Local Development (Lando)

- **URL**: See Project Configuration above
- **Database**: accessible at `database:3306` (credentials in `.lando.yml`)
- **Xdebug**: `lando xdebug-on` / `lando xdebug-off`
- **Rebuild**: `lando rebuild`

## Architecture Overview

### Technology Stack

**Backend:**
- **Craft CMS 5** (CMS)
- Craft plugins: Contact Form, Contact Form Honeypot, Contact Form Extensions, CKEditor, SEO (Ether), Field Manager (Verbb), oEmbed, Vite integration
- Custom Yii2 modules for extending functionality
- Twig templating engine

**Frontend:**
- **Vue 3** for interactive components
- **Vite** for bundling and dev server (replaces Webpack)
- **Tailwind CSS 4** for styling
- **PostCSS** with autoprefixer, nested, and nesting plugins
- ESLint and Stylelint for code quality

### Project Structure

```
/config                 # Craft CMS configuration
  /project              # Project Config (YAML) - version controlled Craft settings
  app.php               # App/module registration
  general.php           # General Craft settings
  vite.php              # Vite integration config
  routes.php            # Custom URL routes

/modules                # Custom Yii2 modules
  ContactFormModule.php # Contact form customization
  /imagemodule          # Image processing module

/templates              # Twig templates
  _layout.twig          # Base layout
  _page.twig            # Page template wrapper
  _default.twig         # Default entry template
  /_includes            # Reusable template partials
  /blog                 # Blog templates
  /services             # Services templates

/public                 # Web root
  /build                # Compiled assets (generated by Vite)
  /assets               # Craft-managed assets (symlinked in prod)
  /js/src               # Source JavaScript
    public.js           # Main public entry point
    editor.js           # CKEditor customizations
    /common             # Shared Vue components
  /css                  # Source CSS
  /images               # Static images

/storage                # Craft runtime files (logs, cache, sessions)
```

### Custom Modules

The application bootstraps three custom Yii2 modules in `config/app.php`:

1. **ContactFormModule** (`modules/ContactFormModule.php`):
   - Customizes Craft's Contact Form plugin behavior
   - Sets from address to default mailer from
   - Adds custom validation for name, email, and message fields
   - Modifies subject line format

2. **XmModule** (`modules/xmmodule/`):
   - Custom XM Media functionality
   - PSR-4 autoloaded from `modules/xmmodule/src/`

3. **ImageModule** (`modules/imagemodule/`):
   - Custom image processing functionality
   - PSR-4 autoloaded from `modules/imagemodule/src/`

### Frontend Build System

**Vite Configuration** (`vite.config.mjs`):
- Two entry points: `public.js` and `editor.js`
- Output directory: `public/build`
- Dev server port and CORS origin: See Project Configuration
- HTTPS via mkcert
- Manifest mode for Craft integration
- No inlined assets (all files separate)

**Vue Integration**:
- Vue 3 Composition API available
- Components mounted via `createApp()` in entry files
- Example: Menu component mounted to `#menu` element
- See `TEMPLATES.md` for Vue component structure templates

**CSS Processing**:
- Tailwind CSS 4 (via `@tailwindcss/vite` plugin)
- PostCSS with env-function, nested, and nesting plugins
- Source maps enabled in dev mode

### Deployment

**GitLab CI/CD** (`.gitlab-ci.yml`):
- **Static stage**: Runs security checks, linting (JS/CSS)
- **Deploy stages**: Staging and Production (manual trigger, main branch only)
- Deployment process:
  1. Security audits (Symfony, Composer, npm)
  2. Install dependencies and build assets
  3. rsync to timestamped release directory
  4. Symlink shared folders (storage, public/assets)
  5. Run Craft migrations and clear caches
  6. Reload PHP-FPM
  7. Clean up old releases (keeps 2 most recent)

**Shared Directories** (persist across deploys):
- `storage/` - logs, cache, sessions, rebrand assets
- `public/assets/` - user-uploaded content

### Content Management

**Craft Project Config**:
- All schema/settings version-controlled in `config/project/*.yaml`
- Changes propagated via `./craft up` (applies project config)
- Includes: fields, sections, entry types, volumes, transforms, category groups, global sets

**Entry Types and Sections**:
- Organized in `config/project/sections/` and `config/project/entryTypes/`
- Blog section with dedicated templates
- Services section with dedicated templates

## Development Workflow

1. **Making Template Changes**: Edit files in `templates/`, Craft auto-detects changes
2. **Making JS/CSS Changes**:
   - Run `yarn dev` for Vite dev server with HMR
   - Changes appear immediately in browser
   - Production build via `yarn build` before deploy
3. **Adding Craft Fields/Sections**:
   - Make changes in Craft admin UI
   - Project Config auto-saves to `config/project/`
   - Commit YAML files to git
   - Other environments apply via `./craft up`
4. **PHP Module Changes**:
   - Edit files in `modules/`
   - Clear Craft caches: `./craft clear-caches/all`
   - May need to restart PHP-FPM in production

## Code Style and Patterns

**PHP**:
- PSR-4 autoloading for modules
- PHPStan config available (`phpstan.neon.dist`)
- Declare strict types in all files

**JavaScript**:
- ESLint config in `eslint.config.mjs` (Flat Config format)
- Vue 3 style guide conventions
- See `TEMPLATES.md` for component structure

**CSS**:
- Tailwind utility-first approach
- Stylelint with Tailwind config (`stylelint.config.mjs`)
- Use `@apply` sparingly

**Twig**:
- Consistent naming: partials prefixed with `_`
- Layout inheritance via `_layout.twig`
- Page wrapper pattern via `_page.twig`

## Environment Configuration

- **Environment file**: `.env` (not in git, see `.env.example`)
- **Environment detection**:
  - `ENVIRONMENT` or `CRAFT_ENVIRONMENT` env var
  - Controls Vite dev server usage, error display, etc.
- **Multi-environment config**: Use `App::env()` in config files

## Important Notes

- **Craft License**: Stored in `config/license.key` (not in git on staging/prod)
- **Rebrand Assets**: Craft admin logo customizations in `config/rebrand/`, deployed to `storage/rebrand/`
- **Session Storage**: Custom path in `storage/sessions/` (configured in `config/app.php`)
- **SVG Processing**: SVGO config in `svgo.config.cjs`
- **Git Hooks**: None configured
- **Browserlist**: Specified in `.browserslistrc`

## Updating PHP Version

When updating PHP (currently 8.5):
1. Update `composer.json` require version
2. Update in:
   - `.lando.yml` – `config.php` and `services.appserver.type` (if the Symfony recipe doesn't support the new version, override appserver with `type: php:X.X`)
   - `setup_dev.sh` – 4 places
   - `setup_prod.sh` – 4 places
   - `.gitlab-ci.yml` – 3 places (default image, `SERVER_PHP_PATH`, `php-fpm` service name)
3. Run `lando rebuild`
4. Update `composer.lock` via `lando composer update`
5. Update version in `README.md` and `CLAUDE.md`
